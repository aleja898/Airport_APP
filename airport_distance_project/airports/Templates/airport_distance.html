{% extends 'base.html' %}

{% block title %}Calculadora de Distancia entre Aeropuertos{% endblock %}

{% block header_title %}Calculadora de Distancias{% endblock %}
{% block header_subtitle %}Encuentra la distancia entre cualquier par de aeropuertos{% endblock %}

{% block content %}
<div class="card">
    <h2 style="color: var(--azul-principal); margin-bottom: 1.5rem; text-align: center;">
        Ingresa los Códigos IATA
    </h2>

    <form id="airportForm" method="post">
        {% csrf_token %}

        <div class="form-group">
            <label for="aeropuerto_origen">Aeropuerto de Origen:</label>
            <input
                type="text"
                id="aeropuerto_origen"
                name="aeropuerto_origen"
                class="form-control"
                placeholder="Ej: BOG (Bogotá)"
                maxlength="3"
                pattern="[A-Za-z]{3}"
                title="Ingrese código IATA de 3 letras"
                required
            >
        </div>

        <div class="form-group">
            <label for="aeropuerto_destino">Aeropuerto de Destino:</label>
            <input
                type="text"
                id="aeropuerto_destino"
                name="aeropuerto_destino"
                class="form-control"
                placeholder="Ej: JFK (Nueva York)"
                maxlength="3"
                pattern="[A-Za-z]{3}"
                title="Ingrese código IATA de 3 letras"
                required
            >
        </div>

        <div style="text-align: center;">
            <button type="submit" class="btn btn-primary">
                ✈️ Calcular Distancia
            </button>
        </div>
    </form>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Calculando distancia...</p>
    </div>

    <div id="resultados" style="display: none;">
        <h3 style="text-align: center; color: var(--azul-principal); margin-top: 2rem;">
            Resultados del Cálculo
        </h3>

        <div class="resultado-aeropuertos">
            <div class="card resultado-card">
                <h4 class="card-title">Origen <img src="https://cdn-icons-png.flaticon.com/512/4337/4337485.png" alt="Logo de origen" width="20px"></h4>
                <p><strong>Código:</strong> <span id="origen_codigo"></span></p>
                <p><strong>Nombre:</strong> <span id="origen_nombre"></span></p>
                <p><strong>Ubicación:</strong> <span id="origen_ciudad_pais"></span></p>
                <p><strong>Zona horaria:</strong> <span id="origen_zona_horaria"></span></p>
            </div>
            <div class="card resultado-card">
                <h4 class="card-title">Destino <img src="https://cdn-icons-png.flaticon.com/512/854/854894.png" alt="Logo de destino" width="20px"></h4>
                <p><strong>Código:</strong> <span id="destino_codigo"></span></p>
                <p><strong>Nombre:</strong> <span id="destino_nombre"></span></p>
                <p><strong>Ubicación:</strong> <span id="destino_ciudad_pais"></span></p>
                <p><strong>Zona horaria:</strong> <span id="destino_zona_horaria"></span></p>
            </div>
        </div>

        <div class="card resultado-card distancia-card">
            <h4 class="card-title">Distancia Calculada 📏</h4>
            <div class="resultado-item">
                <span class="resultado-label">Kilómetros:</span>
                <span class="resultado-valor" id="distancia_km"></span>
            </div>
            <div class="resultado-item">
                <span class="resultado-label">Millas:</span>
                <span class="resultado-valor" id="distancia_millas"></span>
            </div>
            <div class="resultado-item">
                <span class="resultado-label">Millas náuticas:</span>
                <span class="resultado-valor" id="distancia_nauticas"></span>
            </div>
        </div>
    </div>

    <div id="error" class="alert alert-error" style="display: none;"></div>

    <div class="alert alert-info" style="margin-top: 2rem;">
        <strong>💡 Tip:</strong> Los códigos IATA son de 3 letras. Ejemplos: BOG (Bogotá), JFK (Nueva York), LHR (Londres), NRT (Tokio).
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('airportForm');
        
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const resultados = document.getElementById('resultados');
                const error = document.getElementById('error');
                const loading = document.getElementById('loading');
                
                if (resultados) resultados.style.display = 'none';
                if (error) error.style.display = 'none';
                if (loading) loading.style.display = 'block';
                
                const origenInput = document.getElementById('aeropuerto_origen');
                const destinoInput = document.getElementById('aeropuerto_destino');
                
                if (origenInput) origenInput.classList.remove('error', 'success');
                if (destinoInput) destinoInput.classList.remove('error', 'success');
                
                const origen = origenInput ? origenInput.value.trim().toUpperCase() : '';
                const destino = destinoInput ? destinoInput.value.trim().toUpperCase() : '';
                
                // ... (Las validaciones del lado del cliente son las mismas) ...
                if (!origen || !destino) {
                    mostrarError('Debe ingresar ambos códigos de aeropuerto');
                    return;
                }
                
                if (origen.length !== 3 || destino.length !== 3) {
                    mostrarError('Los códigos IATA deben tener exactamente 3 caracteres');
                    return;
                }
                
                if (!/^[A-Z]{3}$/.test(origen) || !/^[A-Z]{3}$/.test(destino)) {
                    mostrarError('Los códigos deben contener solo letras');
                    return;
                }
                
                if (origen === destino) {
                    mostrarError('Los códigos de aeropuerto no pueden ser iguales');
                    return;
                }
                
                const formData = new FormData();
                formData.append('aeropuerto_origen', origen);
                formData.append('aeropuerto_destino', destino);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                fetch('/calculate/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (loading) loading.style.display = 'none';
                    
                    if (data.success) {
                        if (origenInput) origenInput.classList.add('success');
                        if (destinoInput) destinoInput.classList.add('success');
                        
                        // Actualizar información de origen
                        document.getElementById('origen_codigo').textContent = data.aeropuerto_origen.codigo;
                        document.getElementById('origen_nombre').textContent = data.aeropuerto_origen.nombre;
                        document.getElementById('origen_ciudad_pais').textContent = `${data.aeropuerto_origen.ciudad}, ${data.aeropuerto_origen.pais}`;
                        document.getElementById('origen_zona_horaria').textContent = data.aeropuerto_origen.zona_horaria;
                        
                        // Actualizar información de destino
                        document.getElementById('destino_codigo').textContent = data.aeropuerto_destino.codigo;
                        document.getElementById('destino_nombre').textContent = data.aeropuerto_destino.nombre;
                        document.getElementById('destino_ciudad_pais').textContent = `${data.aeropuerto_destino.ciudad}, ${data.aeropuerto_destino.pais}`;
                        document.getElementById('destino_zona_horaria').textContent = data.aeropuerto_destino.zona_horaria;
                        
                        // Actualizar distancias
                        document.getElementById('distancia_km').textContent = new Intl.NumberFormat('es-CO').format(Math.round(data.distancia_km)) + ' km';
                        document.getElementById('distancia_millas').textContent = new Intl.NumberFormat('es-CO').format(Math.round(data.distancia_millas)) + ' mi';
                        document.getElementById('distancia_nauticas').textContent = new Intl.NumberFormat('es-CO').format(Math.round(data.distancia_millas_nauticas)) + ' nm';
                        
                        if (resultados) {
                            resultados.style.display = 'block';
                            resultados.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                    } else {
                        mostrarError(data.error || 'Error desconocido');
                    }
                })
                .catch(error => {
                    if (loading) loading.style.display = 'none';
                    mostrarError('Error de conexión. Verifique su conexión a internet.');
                    console.error('Error:', error);
                });
            });
        }
        
        // ... (Funciones auxiliares para mayúsculas y errores, son las mismas) ...
        const origenInput = document.getElementById('aeropuerto_origen');
        const destinoInput = document.getElementById('aeropuerto_destino');
        
        if (origenInput) {
            origenInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                e.target.classList.remove('error', 'success');
            });
        }
        
        if (destinoInput) {
            destinoInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                e.target.classList.remove('error', 'success');
            });
        }
    });
    
    function mostrarError(mensaje) {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const origenInput = document.getElementById('aeropuerto_origen');
        const destinoInput = document.getElementById('aeropuerto_destino');
        
        if (loading) loading.style.display = 'none';
        
        if (error) {
            error.textContent = mensaje;
            error.style.display = 'block';
            
            error.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
        
        if (origenInput) origenInput.classList.add('error');
        if (destinoInput) destinoInput.classList.add('error');
    }
</script>
{% endblock %}